{"version":3,"file":"parseCellValue.js","names":["parseCellValue","value","type","getInlineStringValue","getInlineStringXml","getStyleId","styles","values","properties","options","parseString","undefined","Error","sharedStringIndex","Number","isNaN","length","decodeError","parsedDate","Date","valueOf","parsedNumber","isDateTimestamp","parseDate","TypeError","errorCode","trim"],"sources":["../../source/read/parseCellValue.js"],"sourcesContent":["import parseDate from './parseDate.js'\r\nimport isDateTimestamp from './isDateTimestamp.js'\r\n\r\n// Parses a string `value` of a cell.\r\nexport default function parseCellValue(value, type, {\r\n  getInlineStringValue,\r\n  getInlineStringXml,\r\n  getStyleId,\r\n  styles,\r\n  values,\r\n  properties,\r\n  options\r\n}) {\r\n  if (!type) {\r\n    // Default cell type is \"n\" (numeric).\r\n    // http://www.datypic.com/sc/ooxml/t-ssml_CT_Cell.html\r\n    type = 'n'\r\n  }\r\n\r\n  // Available Excel cell types:\r\n  // https://github.com/SheetJS/sheetjs/blob/19620da30be2a7d7b9801938a0b9b1fd3c4c4b00/docbits/52_datatype.md\r\n  //\r\n  // Some other document (seems to be old):\r\n  // http://webapp.docx4java.org/OnlineDemo/ecma376/SpreadsheetML/ST_CellType.html\r\n  //\r\n  switch (type) {\r\n    // XLSX tends to store all strings as \"shared\" (indexed) ones\r\n    // using \"s\" cell type (for saving on strage space).\r\n    // \"str\" cell type is then generally only used for storing\r\n    // formula-pre-calculated cell values.\r\n    case 'str':\r\n      value = parseString(value, options)\r\n      break\r\n\r\n    // Sometimes, XLSX stores strings as \"inline\" strings rather than \"shared\" (indexed) ones.\r\n    // Perhaps the specification doesn't force it to use one or another.\r\n    // Example: `<sheetData><row r=\"1\"><c r=\"A1\" s=\"1\" t=\"inlineStr\"><is><t>Test 123</t></is></c></row></sheetData>`.\r\n    case 'inlineStr':\r\n      value = getInlineStringValue()\r\n      if (value === undefined) {\r\n        throw new Error(`Unsupported \"inline string\" cell value structure: ${getInlineStringXml()}`)\r\n      }\r\n      value = parseString(value, options)\r\n      break\r\n\r\n    // XLSX tends to store string values as \"shared\" (indexed) ones.\r\n    // \"Shared\" strings is a way for an Excel editor to reduce\r\n    // the file size by storing \"commonly used\" strings in a dictionary\r\n    // and then referring to such strings by their index in that dictionary.\r\n    // Example: `<sheetData><row r=\"1\"><c r=\"A1\" s=\"1\" t=\"s\"><v>0</v></c></row></sheetData>`.\r\n    case 's':\r\n      // If a cell has no value then there's no `<c/>` element for it.\r\n      // If a `<c/>` element exists then it's not empty.\r\n      // The `<v/>`alue is a key in the \"shared strings\" dictionary of the\r\n      // XLSX file, so look it up in the `values` dictionary by the numeric key.\r\n      const sharedStringIndex = Number(value)\r\n      if (isNaN(sharedStringIndex)) {\r\n        throw new Error(`Invalid \"shared\" string index: ${value}`)\r\n      }\r\n      if (sharedStringIndex >= values.length) {\r\n        throw new Error(`An out-of-bounds \"shared\" string index: ${value}`)\r\n      }\r\n      value = values[sharedStringIndex]\r\n      value = parseString(value, options)\r\n      break\r\n\r\n    // Boolean (TRUE/FALSE) values are stored as either \"1\" or \"0\"\r\n    // in cells of type \"b\".\r\n    case 'b':\r\n      if (value === '1') {\r\n        value = true\r\n      } else if (value === '0') {\r\n        value = false\r\n      } else {\r\n        throw new Error(`Unsupported \"boolean\" cell value: ${value}`)\r\n      }\r\n      break\r\n\r\n    // XLSX specification seems to support cells of type \"z\":\r\n    // blank \"stub\" cells that should be ignored by data processing utilities.\r\n    case 'z':\r\n      value = undefined\r\n      break\r\n\r\n    // XLSX specification also defines cells of type \"e\" containing a numeric \"error\" code.\r\n    // It's not clear what that means though.\r\n    // They also wrote: \"and `w` property stores its common name\".\r\n    // It's unclear what they meant by that.\r\n    case 'e':\r\n      value = decodeError(value)\r\n      break\r\n\r\n    // XLSX supports date cells of type \"d\", though seems like it (almost?) never\r\n    // uses it for storing dates, preferring \"n\" numeric timestamp cells instead.\r\n    // The value of a \"d\" cell is supposedly a string in \"ISO 8601\" format.\r\n    // I haven't seen an XLSX file having such cells.\r\n    // Example: `<sheetData><row r=\"1\"><c r=\"A1\" s=\"1\" t=\"d\"><v>2021-06-10T00:47:45.700Z</v></c></row></sheetData>`.\r\n    case 'd':\r\n      if (value === undefined) {\r\n        break\r\n      }\r\n      const parsedDate = new Date(value)\r\n      if (isNaN(parsedDate.valueOf())) {\r\n        throw new Error(`Unsupported \"date\" cell value: ${value}`)\r\n      }\r\n      value = parsedDate\r\n      break\r\n\r\n    // Numeric cells have type \"n\".\r\n    case 'n':\r\n      if (value === undefined) {\r\n        break\r\n      }\r\n      const parsedNumber = Number(value)\r\n      if (isNaN(parsedNumber)) {\r\n        throw new Error(`Invalid \"numeric\" cell value: ${value}`)\r\n      }\r\n      value = parsedNumber\r\n      // XLSX does have \"d\" type for dates, but it's not commonly used.\r\n      // Instead, it prefers using \"n\" type for storing dates as timestamps.\r\n      if (isDateTimestamp(value, getStyleId(), styles, options)) {\r\n        // Parse the number as a date timestamp.\r\n        value = parseDate(value, properties)\r\n      }\r\n      break\r\n\r\n    default:\r\n      throw new TypeError(`Cell type not supported: ${type}`)\r\n  }\r\n\r\n  // Convert empty values to `null`.\r\n  if (value === undefined) {\r\n    value = null\r\n  }\r\n\r\n  return value\r\n}\r\n\r\n// Decodes numeric error code to a string code.\r\n// https://github.com/SheetJS/sheetjs/blob/19620da30be2a7d7b9801938a0b9b1fd3c4c4b00/docbits/52_datatype.md\r\nfunction decodeError(errorCode) {\r\n  // While the error values are determined by the application,\r\n  // the following are some example error values that could be used:\r\n  switch (errorCode) {\r\n    case 0x00:\r\n      return '#NULL!'\r\n    case 0x07:\r\n      return '#DIV/0!'\r\n    case 0x0F:\r\n      return '#VALUE!'\r\n    case 0x17:\r\n      return '#REF!'\r\n    case 0x1D:\r\n      return '#NAME?'\r\n    case 0x24:\r\n      return '#NUM!'\r\n    case 0x2A:\r\n      return '#N/A'\r\n    case 0x2B:\r\n      return '#GETTING_DATA'\r\n    default:\r\n      // Such error code doesn't exist. I made it up.\r\n      return `#ERROR_${errorCode}`\r\n  }\r\n}\r\n\r\nfunction parseString(value, options) {\r\n  // In some weird cases, a developer might want to disable\r\n  // the automatic trimming of all strings.\r\n  // For example, leading spaces might express a tree-like hierarchy.\r\n  // https://github.com/catamphetamine/read-excel-file/pull/106#issuecomment-1136062917\r\n  if (options.trim !== false) {\r\n    value = value.trim()\r\n  }\r\n  if (value === '') {\r\n    value = undefined\r\n  }\r\n  return value\r\n}"],"mappings":"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"}